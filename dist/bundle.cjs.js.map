{"version":3,"file":"bundle.cjs.js","sources":["../src/index.js"],"sourcesContent":["import _ from 'lodash';\nimport humps from 'humps';\nimport socketIO from 'socket.io';\n\nasync function useAuth(keys, socket, next) {\n  let errors = [];\n  socket.userProps = {};\n\n  keys.forEach((item) => {\n    let { key, header, required } = item;\n    let value = _.get(socket, `request.headers['${header}']`);\n\n    if (required && _.isUndefined(value)) {\n      errors.push({\n        key,\n        message: 'required',\n      });\n      return null;\n    }\n\n    socket.userProps[key] = value;\n    return null;\n  });\n\n  if (errors && errors.length) {\n    socket.authErrors = errors;\n  }\n  next();\n  return null;\n}\n\nasync function checkAuth(client) {\n  if (client.authErrors) {\n    logger.info('client.authErrors: ', client.authErrors);\n    client.emit('unauthorized', { message: client.authErrors }, () => {\n      client.disconnect();\n    });\n  }\n}\n\nclass Ofa2SocketIO {\n  constructor({\n    server, socketHeaderKeys = [], auth = true, autoJoinRoom = true, propGet = true,\n  }) {\n    this.server = server;\n    this.socketHeaderKeys = socketHeaderKeys;\n    this.auth = auth;\n    this.autoJoinRoom = autoJoinRoom;\n    this.propGet = propGet;\n\n    this.io = null;\n\n    this.keys = [];\n    this.connectionListeners = [];\n  }\n\n  create() {\n    this.parseSocketHeaderKeys();\n    let extraHeader = _.map(this.keys, 'header');\n\n    this.io = socketIO(this.server, {\n      handlePreflightRequest(req, res) {\n        extraHeader.unshift(...['content-type', 'authorization']);\n\n        let headers = {\n          'Access-Control-Allow-Headers': `${extraHeader.join(',')}`,\n          'Access-Control-Allow-Origin': req.headers.origin,\n          'Access-Control-Allow-Credentials': true,\n        };\n        res.writeHead(200, headers);\n        res.end();\n      },\n    });\n\n    // 权限验证\n    if (this.auth) {\n      this.io.use((socket, next) => {\n        return useAuth(this.keys, socket, next);\n      });\n\n      this.connectionListeners.push(checkAuth.bind(this));\n    }\n\n    // 加入某个 room\n    if (this.autoJoinRoom) {\n      this.connectionListeners.push((client) => {\n        client.join(this.getRoomId(client));\n      });\n    }\n\n    // 快捷获取 属性\n    if (this.propGet) {\n      this.connectionListeners.push((client) => {\n        client.get = (propPath, defaultValue) => {\n          return _.get(client.userProps, propPath, defaultValue);\n        };\n      });\n    }\n\n    // client error 监听\n    this.connectionListeners.push((client) => {\n      client.on('error', (error) => {\n        logger.warn('socket client error: ', error);\n      });\n    });\n\n    this.watchConnect();\n  }\n\n  get() {\n    return this.io;\n  }\n\n  getRoomId(obj) {\n    let props;\n    if (obj.userProps) {\n      props = obj.userProps;\n    }\n    else {\n      props = obj;\n    }\n\n    let params = _.map(this.keys, 'key');\n\n    return params\n      .map((key) => {\n        let value = props[key];\n        if (_.isString(value) || _.isNumber(value)) {\n          return `${key}:${value}`;\n        }\n        logger.warn(`${key}.value should be string, but got`, value);\n        return undefined;\n      })\n      .filter((value) => {\n        return value !== undefined;\n      })\n      .join('|');\n  }\n\n  emit(clientPropsOrRoomId, data, event) {\n    if (!clientPropsOrRoomId) {\n      logger.debug('emit to all with event: ', event, 'data: ', data);\n      this.io.emit(event, data);\n    }\n\n    let roomId;\n    if (_.isString(clientPropsOrRoomId)) {\n      roomId = clientPropsOrRoomId;\n    }\n    else {\n      roomId = this.getRoomId(clientPropsOrRoomId);\n    }\n\n    if (!roomId) {\n      throw new Error('no roomId found');\n    }\n\n    logger.debug('roomId: ', roomId);\n    logger.debug('event: ', event);\n    logger.debug('data: ', data);\n\n    this.io.to(roomId).emit(event, data);\n    this.io.in(roomId).clients((err, clients) => {\n      if (err) {\n        return null;\n      }\n      logger.debug(`${roomId} clients length: `, clients.length);\n      return null;\n    });\n  }\n\n  addConnectionListener(fun) {\n    this.connectionListeners.push(fun);\n  }\n  removeConnectionListener(fun) {\n    this.connectionListeners.splice(this.connectionListeners.indexOf(fun), 1);\n  }\n\n  watchConnect() {\n    this.io.on('connection', (client) => {\n      logger.info('socket.io client connect, roomId:', this.getRoomId(client));\n      this.connectionListeners.forEach((listener) => {\n        listener(client);\n      });\n    });\n  }\n\n  parseSocketHeaderKeys() {\n    this.keys = _.map(this.socketHeaderKeys, (item) => {\n      if (_.isString(item)) {\n        return {\n          key: item,\n          header: humps.decamelize(item, { separator: '-' }),\n          required: false,\n        };\n      }\n      else if (_.isPlainObject(item)) {\n        return {\n          key: item.key,\n          header: item.header ? item.header : `x-${humps.decamelize(item.key, { separator: '-' })}`,\n          required: !!item.required,\n        };\n      }\n\n      throw new Error(`not support header key: ${JSON.stringify(item)}`);\n    });\n\n    this.keys = _.sortBy(this.keys, 'key');\n  }\n}\n\nasync function lift() {\n  let {\n    headerKeys, auth, autoJoinRoom, propGet,\n  } = this.config.socket;\n\n  let ofa2SocketIO = new Ofa2SocketIO(this.server, headerKeys, auth, autoJoinRoom, propGet);\n  ofa2SocketIO.create();\n\n  this.io = ofa2SocketIO;\n}\n\nasync function lower() {\n  this.io.close();\n}\n\nexport default { lift, lower };\n"],"names":["useAuth","keys","socket","next","errors","userProps","forEach","item","value","_","get","header","required","isUndefined","push","key","length","authErrors","checkAuth","client","info","emit","disconnect","Ofa2SocketIO","server","socketHeaderKeys","auth","autoJoinRoom","propGet","io","connectionListeners","parseSocketHeaderKeys","extraHeader","map","socketIO","req","res","unshift","headers","join","origin","writeHead","end","use","bind","getRoomId","propPath","defaultValue","on","error","warn","watchConnect","obj","props","params","isString","isNumber","undefined","filter","clientPropsOrRoomId","data","event","debug","roomId","Error","to","in","clients","err","fun","splice","indexOf","listener","humps","decamelize","isPlainObject","JSON","stringify","sortBy","lift","config","ofa2SocketIO","headerKeys","create","lower","close"],"mappings":"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"}